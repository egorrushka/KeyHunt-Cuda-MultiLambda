name: Build KeyHunt-Cuda with Multi-Lambda

on:
  push:
    branches: [ main, feature/multi-lambda ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019  # Используем более старую, но стабильную версию Windows
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup CUDA 10.2 (manual download)
      shell: powershell
      run: |
        # Скачиваем CUDA 10.2 напрямую с NVIDIA
        $url = "https://developer.download.nvidia.com/compute/cuda/10.2/Prod/local_installers/cuda_10.2.89_441.22_win10.exe"
        $output = "cuda_10.2.89_441.22_win10.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "CUDA downloaded"

        # Распаковываем без установки драйвера
        Start-Process -FilePath $output -ArgumentList "-s nvcc_10.2 cublas_dev_10.2 cudart_10.2" -Wait -NoNewWindow
        Write-Host "CUDA extracted"

        # Добавляем в PATH
        $env:PATH = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v10.2\bin;$env:PATH"
        [Environment]::SetEnvironmentVariable("PATH", $env:PATH, [EnvironmentVariableTarget]::Machine)
        [Environment]::SetEnvironmentVariable("CUDA_PATH", "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v10.2", [EnvironmentVariableTarget]::Machine)

    - name: Verify CUDA
      run: |
        nvcc --version
        echo "CUDA_PATH: $env:CUDA_PATH"

    - name: Install Visual Studio components
      run: |
        choco install visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64"
        choco install vswhere

    - name: Configure with CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 16 2019" -A x64 `
          -DCMAKE_CUDA_COMPILER="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v10.2/bin/nvcc.exe" `
          -DCMAKE_CUDA_ARCHITECTURES="86" `
          -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        cmake --build . --config Release --target ALL_BUILD -j 2

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: KeyHunt-Cuda-MultiLambda-EXE
        path: build/Release/*.exe
        retention-days: 90